# Direction of Arrival (DOA) Analysis

This module provides Direction of Arrival (DOA) analysis functionality for multi-microphone audio recordings. It can process pre-recorded MP3 files from 4 microphones and estimate the direction of the audio source using various DOA algorithms.

## Overview

The DOA analysis module (`doa_analysis.py`) processes microphone recordings to determine where a sound came from. It supports multiple DOA estimation algorithms and provides 2D visualization of the results.

## Features

- **Multi-Algorithm Support**: Implements three DOA algorithms:
  - **MUSIC** (Multiple Signal Classification): High-resolution subspace-based method
  - **SRP-PHAT** (Steered Response Power with Phase Transform): Robust beamforming approach
  - **FRIDA** (FRI-based DOA): Finite Rate of Innovation based estimation

- **Flexible Input**: Works with any set of 4 microphone MP3 recordings
- **Visualization**: Generates 2D polar plots showing estimated directions
- **Configurable**: Supports custom microphone array geometries
- **Validation**: Can compare estimates against known source positions

## Requirements

The following packages are required (see `requirements.txt`):
- pyroomacoustics
- numpy
- matplotlib
- pydub

## Usage

### Basic Usage

The simplest way to use the DOA analysis is through the main `analyze_doa()` function:

```python
from doa_analysis import analyze_doa

# Analyze microphone recordings from a directory
results = analyze_doa(
    dir_name="example_mp3_audio_sources",  # Directory with mic_1.mp3, mic_2.mp3, etc.
    algorithms=['music', 'srp', 'frida']    # Which algorithms to use
)
```

### Advanced Usage with Known Source Position

If you know the true source position (e.g., from a simulation), you can compare it to the estimates:

```python
import numpy as np
from doa_analysis import analyze_doa

# Define true source position
true_source = np.array([9.0, 9.0, 1.0])  # [x, y, z] in meters

# Run analysis with ground truth for comparison
results = analyze_doa(
    dir_name="example_mp3_audio_sources",
    true_source_position=true_source
)
```

### Custom Microphone Array Geometry

You can specify custom microphone positions:

```python
import numpy as np
from doa_analysis import analyze_doa

# Define microphone positions as (3, num_mics) array
# Each column is [x, y, z] for one microphone
mic_positions = np.array([
    [0.0, 0.1, 0.0, 0.1],  # x coordinates
    [0.1, 0.1, 0.0, 0.0],  # y coordinates
    [0.0, 0.0, 0.0, 0.0]   # z coordinates (all at same height)
])

results = analyze_doa(
    dir_name="my_recordings",
    mic_positions=mic_positions
)
```

## Input File Format

The analysis expects 4 MP3 files in the specified directory:
- `mic_1.mp3` - Recording from microphone 1
- `mic_2.mp3` - Recording from microphone 2
- `mic_3.mp3` - Recording from microphone 3
- `mic_4.mp3` - Recording from microphone 4

These files should be generated by running `example2.py` or similar simulation scripts.

## Output

### Console Output
The analysis prints:
- Progress messages for each algorithm
- Estimated azimuth angles in degrees
- Summary of results from all algorithms

### Visualization
A 2D plot showing:
- Microphone positions (blue dots)
- Estimated directions from each algorithm (colored arrows)
- True source direction if provided (black dashed arrow)
- Compass orientation (N/S/E/W)

The azimuth angle convention is:
- 0째 = North (positive Y direction)
- 90째 = East (positive X direction)
- 180째 = South (negative Y direction)
- 270째 = West (negative X direction)

### Return Value
The function returns a dictionary with algorithm names as keys and DOA objects as values:

```python
{
    'MUSIC': <pyroomacoustics.doa.MUSIC object>,
    'SRP-PHAT': <pyroomacoustics.doa.SRP object>,
    'FRIDA': <pyroomacoustics.doa.FRIDA object>
}
```

Access estimated angles with: `results['MUSIC'].azimuth_recon`

## Example Scripts

### `example_doa.py`
Complete example demonstrating DOA analysis on pre-recorded data:

```bash
python examples/example_doa.py
```

This will:
1. Load microphone recordings from `example_mp3_audio_sources`
2. Run all three DOA algorithms
3. Display a 2D visualization
4. Print a summary of estimated directions

## Algorithm Details

### MUSIC (Multiple Signal Classification)
- **Pros**: High angular resolution, good for narrowband signals
- **Cons**: Sensitive to number of sources, requires eigendecomposition
- **Best for**: Controlled environments with known number of sources

### SRP-PHAT (Steered Response Power with Phase Transform)
- **Pros**: Robust to noise and reverberation
- **Cons**: Lower resolution than MUSIC
- **Best for**: Real-world noisy environments

### FRIDA (FRI-based DOA)
- **Pros**: Can handle multiple sources, computationally efficient
- **Cons**: Requires careful parameter tuning
- **Best for**: Multi-source scenarios

## Workflow Integration

This module integrates with the pyroomacoustics simulation workflow:

1. **Generate Simulation** (`example2.py`):
   - Create room and place microphones
   - Add sound source
   - Simulate and save microphone recordings

2. **Analyze DOA** (`doa_analysis.py`):
   - Load the recorded MP3 files
   - Estimate direction of arrival
   - Visualize and validate results

3. **Iterate**:
   - Adjust microphone positions
   - Try different source locations
   - Compare algorithm performance

## Troubleshooting

### "FileNotFoundError: Could not load mic_X.mp3"
- Ensure the directory contains all 4 microphone files
- Check that file names match exactly: `mic_1.mp3`, `mic_2.mp3`, etc.

### "Warning: No DOA estimates found"
- The signal may be too weak or noisy
- Try adjusting the frequency range in the algorithm calls
- Check that the microphone array has valid geometry

### Poor DOA Accuracy
- Increase the separation between microphones
- Ensure microphones are not co-linear (should form 2D/3D array)
- Check that audio files have sufficient SNR (signal-to-noise ratio)
- Try different frequency ranges for analysis

## References

- Pyroomacoustics Documentation: https://pyroomacoustics.readthedocs.io/
- MUSIC Algorithm: Schmidt, R. (1986). "Multiple emitter location and signal parameter estimation"
- SRP-PHAT: DiBiase, J. H. (2000). "A high-accuracy, low-latency technique for talker localization"

## Future Enhancements

Potential improvements for this module:
- Support for more than 4 microphones
- 3D DOA estimation (azimuth + elevation)
- Real-time DOA analysis
- Multiple source tracking
- Adaptive frequency range selection
- Performance metrics (accuracy, resolution)

